# Details about configuring MPV for high quality video is covered here: https://freetime.mikeconnelly.com/archives/5371
# The latest version of this file is here: https://github.com/classicjazz/mpv-config

# All options are covered here: https://github.com/mpv-player/mpv/blob/master/DOCS/man/options.rst


###########
# General #
###########

# Select either OpenGL or Vulkan (preferred). 
# Note: MacOS devices are limited to OpenGL v4.1 (which is deprecated). 
# For iOS/tvOS/MacOS devices, Metal v2 is preferred but there is not currently a Metal backend

# OpenGL settings
gpu-api=opengl
opengl-pbo=yes
# vd-lavc-dr=yes # requires at least OpenGL v4.4

# Vulkan settings
# gpu-api=vulkan 
# vulkan-async-compute=yes
# vulkan-async-transfer=yes
# vulkan-queue-count=1
# vd-lavc-dr=yes

hwdec=auto # turn off for better quality but slower performance, with software decoding


########
# Misc #
########

border=no # hide the window title bar
msg-color=yes # color log messages on terminal
term-osd-bar=yes # display a progress bar on the terminal
no-hidpi-window-scale # used on 5K iMac to prevent OSX scaling
force-window=immediate
cursor-autohide=1000 # autohide the curser after 1s
deinterlace=no # global reset of deinterlacing to off

##############
# Resolution #
##############

geometry=3840x2160 # force 4k resolution output from on Macs, rather than using MacOS upscaling
# fullscreen = yes # start in fullscreen mode by default


##############
# Colorspace #
##############

icc-contrast=1000 # hides warnings about ICC errors; disable for OLED displays
# icc-profile-auto=yes # enable for OLED displays
target-prim=auto
# target-prim=bt.709
# target-prim=bt.2020 # target Rec.2020 (wide color gamut) for HDR TVs
target-trc=auto
gamma-auto
vf=format=colorlevels=full:colormatrix=auto
video-output-levels=full


##########
# Dither #
##########

dither-depth=auto
temporal-dither=yes


#############
# Debanding #
#############

deband=yes # enabled by default but disabled for 4K videos, below
deband-iterations=4 # deband steps
deband-threshold=20 # deband strength
deband-range=16 # deband range
deband-grain=0 # dynamic grain: set to "0" if using the static grain shader


#######################################
# Motion Interpolation (Smoothmotion) #
#######################################

video-sync=display-resample
interpolation=yes
tscale=oversample
blend-subtitles=yes


################
# Anti-Ringing #
################

scale-antiring=0.7 # luma upscale deringing
dscale-antiring=0.7 # luma downscale deringing
cscale-antiring=0.7 # chroma upscale deringing


#########
# Cache #
#########

# cache=yes
# demuxer-max-bytes=1073741824 # ~1GB
# demuxer-readahead-secs=20


#############################################################
# Upscaling & Processing Based on Source Video's Resolution #
#############################################################

# Chroma subsampling means that chroma information is encoded at lower resolution than luma
# In MPV, chroma is upscaled to luma resolution (video size) and then the converted RGB is upscaled to target resolution (screen size)

fbo-format=rgba16f # use with gpu-api=opengl
# fbo-format=rgba16hf # use with gpu-api=vulkan and comment out previous line
glsl-shaders-clr
glsl-shaders="~/.config/mpv/shaders/noise_static_luma.hook"
glsl-shaders-append="~/.config/mpv/shaders/noise_static_chroma.hook"
# luma upscaling
glsl-shaders-append="~/.config/mpv/shaders/FSRCNNX_x2_8-0-4-1.glsl"
scale=ewa_lanczossharp
# luma downscaling
glsl-shaders-append="~/.config/mpv/Shaders/SSimDownscaler.glsl"
dscale=mitchell
linear-downscaling=yes
# chroma upscaling and downscaling
# glsl-shaders-append="~/.config/mpv/Shaders/KrigBilateral.glsl" # enable this shader if it doesn't result in dropped frames
cscale=mitchell
sigmoid-upscaling=yes


############
# Profiles #
############

# 7680x4320 (UHDTV)
# 3840x2160 (UHDTV)
# No upscaling required
[4k60] # 4K/60fps
profile-desc=cond:((get("video-params/w", -math.huge)>1920 or get("video-params/h", -math.huge)>1080) and ((get("container-fps", -math.huge)>=31 and get("estimated-vf-fps", -math.huge)>=31) or get("container-fps", -math.huge)>=31))
glsl-shaders-clr
deband=no
interpolation=no # turn off interpolation because already 60fps 

[4k30] # 4K/30fps
profile-desc=cond:((get("video-params/w", -math.huge)>1920 or get("video-params/h", -math.huge)>1080) and get("container-fps", -math.huge)<31 and get("estimated-vf-fps", -math.huge)<31)
glsl-shaders-clr
deband=no

# 1920x1080p (progressive Blu-ray)
[full-hd] 
profile-desc=cond:get("video-params/w", -math.huge)==1920 and get("video-params/h", -math.huge)>=1070 and not p["video-frame-info/interlaced"] 

# 1920x1080i (HDTV, interlaced Blu-rays)
[full-hd-interlaced]
profile-desc=cond:get("video-params/w", -math.huge)==1920 and get("video-params/h", -math.huge)>=1070 and p["video-frame-info/interlaced"]
vf=bwdif # apply FFMPEG's bwdif deinterlacer

# 1280x720 (HDTV, Blu-ray - progressive)
[hd]
profile-desc=cond:get("video-params/w", -math.huge)==1280 and get('video-params/h', -math.huge) == 720
interpolation=no # turn off interpolation because already 60fps 

# 352x576 (PAL broadcast - interlaced)
# 480x576 (PAL broadcast - interlaced)
# 544x576 (PAL broadcast - interlaced)
# 720x576 (PAL broadcast or DVD - interlaced)
[sdtv-pal]
profile-desc=cond:(get("video-params/w", -math.huge)==352 or get("video-params/w", -math.huge)==480 or get("video-params/w", -math.huge)==544 or get("video-params/w", -math.huge)==720) and get('video-params/h', -math.huge) == 576
vf=bwdif # apply FFMPEG's bwdif deinterlacer

# 640x480 (NTSC broadcast - interlaced)
# 704x480 (NTSC broadcast - interlaced)
# 720x480 (NTSC DVD - interlaced)
[sdtv-ntsc]
profile-desc=cond:(get("video-params/w", -math.huge)==640 or get("video-params/w", -math.huge)==704 or get("video-params/w", -math.huge)==720) and get('video-params/h', -math.huge) == 480
vf=bwdif # apply FFMPEG's bwdif deinterlacer


[protocol.http]
hls-bitrate=max # use max quality for HLS streams

[protocol.https]
profile=protocol.http

[protocol.ytdl]
profile=protocol.http
